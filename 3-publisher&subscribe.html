<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Document</title>
</head>
<body>
  <script>
    // 发布订阅模式
    // 管理器
    class Dep{
      constructor() {
        // 收集watcher
        this.subs = []
      }
      addSub(sub) {
        // 收集watcher，每个sub都是watch对象
        this.subs.push(sub)
      }
      notify(newValue) {
        // 执行回调函数
        this.subs.forEach(sub => {
          sub.update(newValue)
        })
      }
    }

    // 订阅者 
    // - 触发get: 用于Dep收集watcher
    // - 执行回调函数
    class Watcher{
      constructor(data, key, cb) {
        this.cb = cb
        Dep.target = this
        data[key]; // 触发get
        Dep.target = null
      }
      update(newValue) {
        this.cb(newValue)
      }
    }

    let data = {
      myname: "张三",  
      age: 20
    }

    // 每条数据有一个 dep --> 收集watcher
    function observer(data) {
      let keys = Object.keys(data)
      keys.forEach(key => {
        let value = data[key]
        let dep = new Dep()
        Object.defineProperty(data,key,{
          configurable: true,
          enumerable: true,
          get() {
            console.log('get');
            // 收集watch
            if(Dep.target) {
              dep.addSub(Dep.target)
            }
            return value
          },
          set(newValue) {
            console.log('set');
            // 触发watch
            dep.notify(newValue)
            value = newValue
          }
        })
      })
    }
    observer(data)

    // 每个key都触发get
    for(let key in data){
      new Watcher(data,key,(newValue)=>{
        console.log("触发了更新",newValue);
      })
    }
  </script>
</body>
</html>